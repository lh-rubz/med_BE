"""
LINE-BY-LINE VERIFICATION SYSTEM
==================================

This module implements a "Smart Scanner" system that performs intelligent verification
of medical report extraction by comparing each extracted field against the original image.

ARCHITECTURE:
─────────────

The system works in THREE PASSES:

1. EXTRACTION PASS (existing)
   └─ VLM extracts: Test Name, Value, Unit, Range from image
   └─ Returns: List of extracted fields

2. CLEANING PASS (existing)
   ├─ Filter empty values (*, -, blank markers)
   ├─ Clean ranges (validate format, remove hallucinated)
   ├─ Normalize units (remove symbols, standardize)
   └─ Returns: Cleaned field list

3. VERIFICATION PASS (NEW - Smart Scanner)
   ├─ Full-page verification prompt
   │  └─ VLM compares ALL extracted fields against original image
   │  └─ Identifies any mismatches, missing values, copied data
   │
   ├─ Column-by-column verification
   │  ├─ Test Name column: Exactly matches image?
   │  ├─ Value column: Number/percentage matches image?
   │  ├─ Unit column: Unit symbol matches image?
   │  └─ Range column: Reference range matches image?
   │
   └─ Detailed field verification (if issues found)
      ├─ Individual field verification against image
      ├─ Extract exact values from image for failed fields
      └─ Apply corrections automatically
      
═══════════════════════════════════════════════════════════════════════════════════

KEY FUNCTIONS:
──────────────

1. get_line_by_line_verification_prompt(extracted_fields, page_num, total_pages)
   │
   ├─ Generates VLM prompt for full-page verification
   ├─ Lists all extracted fields to verify
   ├─ Emphasizes column-by-column comparison
   ├─ Instructs VLM to identify issues:
   │  ├─ EMPTY_IN_IMAGE: Value marked with * or - in image
   │  ├─ COPIED_FROM_NEIGHBOR: Value taken from adjacent row
   │  ├─ RANGE_NOT_VISIBLE: Range not shown in image
   │  ├─ UNIT_MISMATCH: Extracted unit differs from image
   │  └─ VALUE_MISMATCH: Extracted value differs from image
   │
   └─ Returns: Detailed verification prompt


2. get_column_distinction_prompt()
   │
   ├─ Emphasizes critical column separation rules
   ├─ Prevents merging of:
   │  ├─ Test Name + Value
   │  ├─ Value + Unit
   │  ├─ Unit + Range
   │  └─ Test Name + Unit
   │
   ├─ Ensures each column contains ONLY its specific data:
   │  ├─ Test Name: "RBC" (not "RBC 4.5 M/uL")
   │  ├─ Value: "4.5" (not "4.5 M/uL")
   │  ├─ Unit: "M/uL" (not "4.5 M/uL")
   │  └─ Range: "(4.2-5.4)" (not with value or unit)
   │
   └─ Returns: Column rules prompt


3. get_field_specific_verification_prompt(field, page_num)
   │
   ├─ Generates verification prompt for individual field
   ├─ Used when full-page verification finds issues
   ├─ Asks VLM to verify each component:
   │  ├─ Is test name in image?
   │  ├─ Is value correct?
   │  ├─ Is unit correct?
   │  └─ Is range correct?
   │
   └─ Returns: Single-field verification prompt


4. verify_extracted_fields_against_image(fields, image_base64, vlm_client, page_num, total_pages)
   │
   ├─ MAIN ENTRY POINT for verification
   ├─ Steps:
   │  ├─ Generate full-page verification prompt
   │  ├─ Call VLM to verify against image
   │  ├─ Parse verification response
   │  ├─ If issues found: Run field-by-field detailed verification
   │  └─ Apply corrections from verification
   │
   ├─ Returns: (verified_fields, verification_report)
   │  ├─ verified_fields: Corrected field list
   │  └─ verification_report: Detailed results
   │
   └─ Handles errors gracefully - returns original fields if verification fails


5. create_verification_report(extracted_fields, vlm_response)
   │
   ├─ Parses VLM verification response
   ├─ Extracts metrics:
   │  ├─ Total fields verified
   │  ├─ Correct fields
   │  ├─ Fields with issues
   │  └─ Critical issues count
   │
   ├─ Determines overall status:
   │  ├─ VERIFIED: 0% issues
   │  ├─ MOSTLY_VERIFIED: <10% issues
   │  └─ NEEDS_CORRECTION: ≥10% issues
   │
   └─ Returns: Structured verification report


6. _should_verify_field_individually(field, verification_response)
   │
   ├─ Determines if field needs detailed verification
   ├─ Checks if field appears in error context
   └─ Returns: boolean


7. _apply_field_verification_corrections(field, vlm_response)
   │
   ├─ Extracts corrections from VLM verification response
   ├─ Updates field with correct value from image
   ├─ Handles patterns:
   │  ├─ "image shows X" → Update value to X
   │  ├─ "range not visible" → Set range to empty
   │  └─ "value is empty" → Set value to empty
   │
   └─ Returns: Corrected field


8. generate_verification_summary_for_user(verification_report)
   │
   ├─ Generates human-readable summary
   ├─ Shows:
   │  ├─ Total fields verified
   │  ├─ Verification status (✓/⚠/✗)
   │  ├─ Count of correct fields
   │  ├─ Count of issues found
   │  └─ List of critical issues
   │
   └─ Returns: Formatted summary string

═══════════════════════════════════════════════════════════════════════════════════

INTEGRATION IN VLM_ROUTES:
─────────────────────────

The verification pass is integrated in the extraction workflow:

1. Extract fields from image (existing)
2. Clean extracted data (existing)
   ├─ Filter empty values
   ├─ Clean ranges
   └─ Normalize units
3. **VERIFY against original image (NEW) ← Smart Scanner**
   ├─ Full-page verification
   ├─ Detailed field verification if needed
   └─ Apply corrections
4. Standardize field names (existing)
5. Save to database (existing)

Position in vlm_routes.py: Lines ~980-1020
Entry point: verify_extracted_fields_against_image()
Called for: Each page of the report

═══════════════════════════════════════════════════════════════════════════════════

EXAMPLE WORKFLOW:
─────────────────

SCENARIO: Page 2 of hematology report

INPUT:
Extracted Fields:
1. RBC, Value: 4.5, Unit: M/uL, Range: (4.2-5.4)
2. Hemoglobin, Value: 12.3, Unit: g/dL, Range: (12-16)  ← Wrong! Image shows 13.5
3. Platelets, Value: 200, Unit: K/uL, Range: (140-400)
... 20 more fields

VERIFICATION PASS:
─────────────────
Smart Scanner generates prompt:
"Compare these 23 extracted fields against the image. For EACH field:
- Column 1 (Test Name): Does image say 'Hemoglobin'? YES
- Column 2 (Value): Does image show '12.3'? NO - image shows '13.5'
- Column 3 (Unit): Does image show 'g/dL'? YES
- Column 4 (Range): Does image show '(12-16)'? YES"

VLM Response:
"[1] RBC ... | Issue: CORRECT
[2] Hemoglobin ... | Issue: VALUE_MISMATCH | Reason: image shows 13.5 not 12.3
[3] Platelets ... | Issue: CORRECT
..."

CORRECTION:
───────────
For field #2, detailed verification extracts:
"Image clearly shows: 13.5"

Field updated:
- OLD: Value: 12.3
- NEW: Value: 13.5
- MARKED: verification_note: "Corrected from verification"

OUTPUT:
Verified fields with correction:
1. RBC, Value: 4.5, Unit: M/uL, Range: (4.2-5.4) ✓
2. Hemoglobin, Value: 13.5, Unit: g/dL, Range: (12-16) ✓ (corrected)
3. Platelets, Value: 200, Unit: K/uL, Range: (140-400) ✓
... 20 more fields

═══════════════════════════════════════════════════════════════════════════════════

PROMPTS USED:
─────────────

FULL-PAGE VERIFICATION PROMPT includes:
├─ Page context information
├─ All extracted fields to verify
├─ Column-by-column verification instructions
├─ Issue type definitions
├─ Column separation rules
└─ Expected response format

DETAILED FIELD VERIFICATION PROMPT includes:
├─ Single field data
├─ Page context
├─ Question for each column
│  ├─ Test Name: Is it in image? If yes/no?
│  ├─ Value: Is it correct? If no, what's in image?
│  ├─ Unit: Is it correct? If no, what's shown?
│  └─ Range: Is it correct? If no, what's shown?
├─ Overall verification status
└─ Expected response format

COLUMN DISTINCTION RULES PROMPT includes:
├─ 4 column definitions (Test Name, Value, Unit, Range)
├─ Examples for each column
├─ Rules against merging columns
└─ Emphasis on column independence

═══════════════════════════════════════════════════════════════════════════════════

ERROR HANDLING:
───────────────

The verification system is designed to be non-blocking:

├─ VLM verification fails?
│  └─ Returns original fields with error status
│  └─ Continues with rest of pipeline
│
├─ Image encoding issue?
│  └─ Skips verification for that page
│  └─ Continues with other pages
│
└─ Detailed verification finds no issues?
   └─ Returns verified fields as-is
   └─ No corrections made

═══════════════════════════════════════════════════════════════════════════════════

CONFIGURATION:
───────────────

Verification is controlled by parameters:
├─ run_detailed_check: bool = True
│  └─ When True: Runs field-by-field verification for failed fields
│  └─ When False: Only runs full-page verification
│
├─ VLM temperature: 0.1 (very low)
│  └─ Forces factual, precise responses
│  └─ Reduces hallucinations
│
└─ Max predictions: 2000 (full page), 500 (per field)

═══════════════════════════════════════════════════════════════════════════════════

TESTING:
────────

To test the verification system:

```python
from utils.vlm_line_by_line_verifier import verify_extracted_fields_against_image
from config import ollama_client
import base64

# Prepare test data
extracted_fields = [
    {
        'field_name': 'RBC',
        'field_value': '4.5',
        'field_unit': 'M/uL',
        'normal_range': '(4.2-5.4)'
    },
    # ... more fields
]

# Load image
with open('path/to/image.png', 'rb') as f:
    image_base64 = base64.b64encode(f.read()).decode('utf-8')

# Run verification
verified_fields, report = verify_extracted_fields_against_image(
    extracted_fields=extracted_fields,
    image_base64=image_base64,
    vlm_client=ollama_client,
    page_num=1,
    total_pages=2,
    run_detailed_check=True
)

# Check results
print(f"Status: {report['verification_status']}")
print(f"Correct: {report['summary']['fields_correct']}")
print(f"Issues: {report['summary']['fields_with_issues']}")
```

═══════════════════════════════════════════════════════════════════════════════════
"""

# This is a documentation file - no code to execute
